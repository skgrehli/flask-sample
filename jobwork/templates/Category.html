<!DOCTYPE html>
<html class=" ">
    <head>
        <!--  
         * @Package: Ultra Admin - Responsive Theme
         * @Subpackage: Bootstrap
         * @Version: 4.1
         * This file is part of Ultra Admin Theme.
        -->
        <title>Category | Admin</title>
        {% include 'meta-tag.html' %}

    </head>
    <!-- END HEAD -->

    <!-- BEGIN BODY -->
    <body class=" " ng-app="categoriesListing" ng-controller="categoriesCtrl" ng-init="changeData()"><!-- START TOPBAR -->
        {% include 'top-menu.html' %}
        <!-- END TOPBAR -->
        <!-- START CONTAINER -->
        <div class="page-container row-fluid">

            <!-- SIDEBAR - START -->
           {% include 'side-left.html' %}
             <!--  SIDEBAR - END -->
            <!-- START CONTENT -->
            <section id="main-content" class=" ">
                <section class="wrapper main-wrapper" style="">

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="page-title">


                          <div class="pull-left">
                               <h1 class="title">Category</h1>                        
                          </div>

                            <!--<div class="pull-right hidden-xs">
                                <ol class="breadcrumb">
                                    <li>
                                        <a href="index.html"><i class="fa fa-home"></i>Home</a>
                                    </li>
                                    <li>
                                        <a href="tables-basic.html">Tables</a>
                                    </li>
                                    <li class="active">
                                        <strong>Data Tables</strong>
                                    </li>
                                </ol>
                            </div>-->

                        </div>
                    </div>
                    <div class="clearfix"></div>




                    <div class="content-body">  
                        <div class="row">
                        
                            <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12" style="margin-bottom: 25px;">
                        <section class="box ">
                            <header class="panel_header">
                                <h2 class="title pull-left">Add Category</h2>
                                <div class="actions panel_actions pull-right">
                                    <!--<i class="box_toggle fa fa-chevron-down"></i>-->
                                    <!--<i class="box_setting fa fa-cog" data-toggle="modal" href="#section-settings"></i>-->
                                    <!--<i class="box_close fa fa-times"></i>-->
                                </div>
                            </header>
                            <div class="content-body">
                                <div class="row">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <form name="addCategoryAdmin" id="addCategoryAdmin" method="POST" ng-submit="addCategory(addCategoryAdmin.$valid)" novalidate> 
                                           <div class="form-group">
                                                <label class="" for="exampleInputEmail3" style="margin-right: 10px;">Category Name</label>
                                                <input type="text" class="form-control" id="categoryname" placeholder="Category name" style="margin-right: 20px;" autofocus autocomplete="off" ng-model="categoryname" required>

                                                <p ng-show="submitted && addCategoryAdmin.categoryname.$error.required" class="error" style="margin-top:0px;">Category Name is required.</p>

                                                <input type="hidden" ng-model="categoryid" value="">
                                            </div>
                                            <div class="form-group">
                                                <label class="" for="exampleInputEmail3" style="margin-right: 10px;">Upload Template Images</label>
                                                <input type="file" onchange="angular.element(this).scope().readURL(this)" style="margin-right: 20px;" ngf-select ng-model="categoryImg" name="img" autofocus autocomplete="off" accept="image/*">
                                                <!-- <p ng-show="submitted && addTemplateAdmin.categoryidfield.$error.required" class="error" style="margin-top:0px;">Template Image is required.</p> -->
                                            </div>
                                                <button type="submit" class="btn btn-primary" ng-disabled="isSaveDisabled" ng-model="saveButton" ng-click="submitted=true" ng-if="flag == false">Save</button>

                                                <button type="submit" class="btn btn-primary" ng-disabled="isUpdateDisabled" ng-model="updateButton" ng-click="submitted=true" ng-if="flag == true">Update</button>
                                                <button type="submit" class="btn btn-primary" ng-disabled="iscancel" ng-model="cancelButton" ng-if="flag == true" ng-click="cancel()">Cancel</button>

                                       </form>

                                    </div>
                                </div>

                            </div>
                        </section>
                        </div>
                            
                            <div class="col-md-12 overComeDiv">
                                <div class="widget">
                                    <div class="widget-header transparent">
                                        <!--<h2><strong>Sortable</strong> Table</h2>-->
                                        
                                        <!--top buttons-->
                                        <div class="row" style="">
                                          <div class="col-md-12 col-sm-12 col-xs-12">
        
        
        
                                                <!-- start -->
        
                                               <!-- <div class="row">
                                                  <div class="col-md-4 col-sm-8 col-xs-8">
                                                            <button type="button" class="btn btn-success" onclick="treedata_create();"><i class="fa fa-asterisk"></i> Create</button>
                                                            <button type="button" class="btn btn-warning" onclick="treedata_rename();"><i class="fa fa-pencil"></i> Rename</button>
                                                            <button type="button" class="btn btn-danger" onclick="treedata_delete();"><i class="fa fa-remove"></i> Delete</button>
                                                        </div>
                                                        <div class="col-md-4 col-sm-4 col-xs-4 pull-right">
                                                            <input type="text" value="" ng-model="search" id="treedata_q" placeholder="Search" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="clearfix"></div>
                                                    <div class="row">
                                                        
                                                    </div> -->
                                        
                                                                                <!-- end -->
                                        
                                            </div>
                                        </div>
                                                           <!--top buttons close-->
                           
                                                            <!--<div class="additional-btn">
                                                                <a href="#" class="hidden reload"><i class="icon-ccw-1"></i></a>
                                                                <a href="#" class="widget-toggle"><i class="icon-down-open-2"></i></a>
                                                                <a href="#" class="widget-close"><i class="icon-cancel-3"></i></a>
                                                            </div>-->
                                        </div>
                                        <div class="widget-content">                    
                                            <div class="table-responsive">
                                                <div class="" style="margin-bottom: 25px;">
                                                    <section class="box">
                                                        <header class="panel_header">
                                                            <h2 class="title pull-left">Filter</h2>
                                                            <div class="actions panel_actions pull-right">
                                                                <!--<i class="box_toggle fa fa-chevron-down"></i>-->
                                                                <!--<i class="box_setting fa fa-cog" data-toggle="modal" href="#section-settings"></i>-->
                                                                <!--<i class="box_close fa fa-times"></i>-->
                                                            </div>
                                                        </header>
                                                        <div class="content-body">
                                                            <div class="row" style="margin-bottom: 25px;display: none;">
                                                                <div class="col-md-12 col-sm-12 col-xs-12">
                                                                    <form name="filterDate" id="filterDate" method="POST" novalidate> 
                                                                       <div class="form-group col-md-6 col-sm-6" style="padding: 0;">
                                                                            <label class="" style="margin-right: 10px;">Start Date</label>
                                                                            <input type="date" id="startgmtDate" class="form-control" ng-change="changeData()" ng-model="startgmtDate" datetime-picker date-format="yyyy-MM-dd HH:mm:ss" size="30" />
                                                                        </div>
                                                                        <div class="form-group col-md-6 col-sm-6" style="padding: 0;">
                                                                            <label class="" style="margin-right: 10px;">End Date</label>
                                                                            <input type="date" class="form-control" id="endgmtDate" ng-model="endgmtDate" ng-change="changeData()" datetime-picker date-format="yyyy-MM-dd HH:mm:ss" size="30" />
                                                                        </div>
                                                                   </form>
                                                                </div>
                                                            </div>

                                                            <table class="table table-striped table-bordered" cellspacing="0" width="100%" datatable="ng" dt-options="showCase.dtOptions">
                                                                <thead>
                                                                    <tr>
                                                                        <!-- <th style="width: 20%;">No</th> -->
                                                                        
                                                                        <!-- <th style="width: 20%;">Category Id</th> -->
                                                                        <th style="width: 20%;">Category Images</th>
                                                                        <th style="width: 40%;">Category Name</th>
                                                                        <th style="width: 20%;">Status</th>
                                                                        <th style="width: 30%;" data-sortable="false">Option</th>
                                                                    </tr>
                                                                </thead>

                                                                
                                                                <tbody>
                                                                    <tr ng-repeat="categoriesPropertyArray in categoriesArray" >
                                                                        
                                                                        <!-- <td>{& $index + 1 &}</td> -->
                                                                        <!-- <td><strong>{& categoriesPropertyArray.categoryid &}</strong></td> -->
                                                                        <td ng-if="categoriesPropertyArray.categoryimage != ''">{&categoriesPropertyArray.categoryimage&}</td>
                                                                        <td>{&categoriesPropertyArray.categoryname&}</td>
                                                                        <td ng-if="categoriesPropertyArray.active == true">Activated</td>
                                                                        <td ng-if="categoriesPropertyArray.active == false">Deactivated</td>
                                                                        <td>
                                                                            <div class="btn-group btn-group-xs" ng-if="categoriesPropertyArray.active == true">
                                                                                <button type="button" class="btn btn-danger" ng-model="act_deactive" ng-click="deactivate(categoriesPropertyArray.categoryid)" style="width: 90px;">Deactivate</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-info" ng-click="edit(categoriesPropertyArray.categoryid, categoriesPropertyArray.categoryname)">Edit</button>
                                                                            </div>
                                                                            <div class="btn-group btn-group-xs" ng-if="categoriesPropertyArray.active == false">
                                                                                <button type="button" class="btn btn-success" ng-model="act_deactive" ng-click="activate(categoriesPropertyArray.categoryid)" style="width: 90px;">Activate</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-info" ng-click="edit(categoriesPropertyArray.categoryid, categoriesPropertyArray.categoryname)">Edit</button>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                   
                                                                </tbody>
                                                            </table>

                                                        </div>
                                                    </section>
                                                </div>
                                                <!-- <div class="col-md-12"><h3><b>Filter :</b></h3></div>
                                                <div class="col-md-12"><span class="col-sm-6"><label>Start Data</label><input type="date" ng-model="gmtDate" datetime-picker date-format="yyyy-MM-dd HH:mm:ss" size="30" /></span><span class="col-sm-6"><label>End Data</label><input type="date" ng-model="gmtDate" datetime-picker date-format="yyyy-MM-dd HH:mm:ss" size="30" /></span></div><br> -->
                                                
                                                
                                                <!-- <p>
                                                   <dir-pagination-controls
                                                       max-size="5"
                                                       direction-links="true"
                                                       boundary-links="true">
                                                   </dir-pagination-controls>  
                                                </p><br><br> -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div><!--row close-->
                    </div><!--content body close-->
                        
                        
                        
                        
                     
                    </section>
                </section>
                <!-- END CONTENT -->
                
                <div class="chatapi-windows ">
                
    
                </div>    
                </div>

                
        <!-- END CONTAINER -->
        <!-- LOAD FILES AT PAGE END FOR FASTER LOADING -->

        {% include 'footer.html' %}
        
        <script>
            var app = angular.module('categoriesListing', ['datatables','ngFileUpload']);
            app.config(function($interpolateProvider) {
                $interpolateProvider.startSymbol('{&');
                $interpolateProvider.endSymbol('&}');
            });
            app.controller('categoriesCtrl', function($scope,$http,$window, DTOptionsBuilder, DTColumnBuilder, Upload) 
            {
                $scope.startgmtDate = new Date();
                $scope.startgmtDate.setMonth($scope.startgmtDate.getMonth() - 480);
                $scope.endgmtDate = new Date();

                $scope.count = 0;
                $scope.userid = {{session['adminid']}};
                $scope.token = "{{session['token']}}";
                $scope.isSaveDisabled = false;
                $scope.isUpdateDisabled = true;
                $scope.flag = false;

                $scope.showCase = {};

                $scope.showCase.dtOptions = DTOptionsBuilder.newOptions()
                  .withOption('order', [0, 'asc']);


                $scope.changeData = function()
                {
                    // console.log($scope.startgmtDate + " " + $scope.endgmtDate);

                    $scope.endgmtDatemonth = $scope.endgmtDate.getMonth() + 1;
                    $scope.endgmtDateday = $scope.endgmtDate.getDate();
                    $scope.startgmtDatemonth = $scope.startgmtDate.getMonth() + 1;
                    $scope.startgmtDateday = $scope.startgmtDate.getDate();
                    
                    if($scope.startgmtDatemonth < 10)
                    {
                        $scope.startgmtDatemonth = "0" + $scope.startgmtDatemonth;
                    }
                    if($scope.startgmtDateday < 10)
                    {
                        $scope.startgmtDateday = "0" + $scope.startgmtDateday;
                    }
                    if($scope.endgmtDatemonth < 10)
                    {
                        $scope.endgmtDatemonth = "0" + $scope.endgmtDatemonth;
                    }
                    if($scope.endgmtDateday < 10) 
                    {
                        $scope.endgmtDateday = "0" + $scope.endgmtDateday;
                    }

                    // var before = day + '-' + oldmonth + '-' + $scope.startgmtDate.getFullYear();
                    $scope.startDateTime = $scope.startgmtDateday + '-' + $scope.startgmtDatemonth + '-' + $scope.startgmtDate.getFullYear() + ' ' + '00:00:00';

                    // var today = endgmtDateday + '-' + endgmtDatemonth + '-' + $scope.endgmtDate.getFullYear();
                    $scope.endDateTime = $scope.endgmtDateday + '-' + $scope.endgmtDatemonth + '-' + $scope.endgmtDate.getFullYear() + ' ' + '23:59:59';
                
                    // console.log($scope.startDateTime + " " + $scope.endDateTime);

                    $http({
                            url: "/categories/list",
                            method: "POST",
                            data: {"userid":$scope.userid, "token":$scope.token, "startDateTime":$scope.startDateTime, "endDateTime":$scope.endDateTime}
                        }).success(function(data, status, headers, config) {
                            console.log(data);
                            //alert(data['_data'].length)
                            $scope.categoriesArray = data['data'];
                            

                        }).error(function(data, status, headers, config) {
                            //alert("hmmm error");
                            // // console.log(data);
                            // // console.log(status);
                            //$scope.status = status;
                            //$window.location.href="/";
                        });
                }

                 $scope.addCategory = function(isValid) 
                    {
                        if (isValid) 
                        {
                        	$http({
                                url: "/categories/add/edit",
                                method: "POST",
                                data: {"userid":$scope.userid, "token":$scope.token, "categoryid":$scope.categoryid, "category":$scope.categoryname}
                            }).success(function(data, status, headers, config) 
                            {
                                // // console.log(data)
                                $scope.categoryname = "";
                                if (data['status'] == 200)
                                {
                                    $scope.catgID = data['last_added_category'][0]['categoryid'];
                                    console.log($scope.url.length,$scope.catgID);
                                    if ($scope.url.length != 0){
                                        $scope.upload($scope.url,$scope.catgID);
                                    }
                                    $scope.categoriesArray = $scope.categoriesArray.concat(data['last_added_category']);
                                    swal("Added!", "Category successfully Added.", "success");
                                }
                                else if (data['status'] == 400)
                                {
                                    swal("Category already added.");
                                }
                                else if (data['status'] == 201)
                                {
                                    $scope.updatecategoryArray = data['last_added_category'];
                                    $scope.catgID = data['last_added_category'][0]['categoryid'];
                                        angular.forEach($scope.updatecategoryArray, function(value, key) {
                                          angular.forEach($scope.categoriesArray, function(value2, key2) {
                                              if (value2.categoryid == value.categoryid)
                                              {
                                                $scope.categoriesArray[key2].categoryname = value.categoryname;
                                                return false;
                                              }
                                            });
                                        });
                                    if ($scope.url.length != 0)
                                    {
                                        $scope.upload($scope.url,$scope.catgID);
                                    }
                                    swal("Update!", "Category successfully Updated.", "success");
                                }

                            }).error(function(data, status, headers, config) {
                                //alert("hmmm error");
                                $scope.status = status;
                                // console.log(data);
                                // console.log(status);
                            });
                        }    
                    };
                $scope.deactivate = function(categoryid) 
                    {
                        if (categoryid) 
                        { 
                            $http({
                                url: "/categories/activate/deactivate",
                                method: "POST",
                                data: {"userid":$scope.userid, "token":$scope.token, "categoryid":categoryid , "action" : false}
                            }).success(function(data, status, headers, config) 
                            {
                               $scope.updatecategory = data['data'];
                                angular.forEach($scope.updatecategory, function(value, key) {
                                  angular.forEach($scope.categoriesArray, function(value2, key2) {
                                      if (value2.categoryid == value.categoryid)
                                      {
                                        $scope.categoriesArray[key2].active = value.active;
                                        return false;
                                      }
                                    });
                                });

                                if (status == 200)
                                {
                                    swal("Deactivate!", "Category successfully deactivated.", "success");
                                }
                                // $scope.languagesArray = $scope.languagesArray.concat(data['last_added_language']);
                                // $scope.languagesArray = $scope.languagesArray.splice(0, 0, data['last_added_skill']);

                            }).error(function(data, status, headers, config) {
                                $scope.status = status;
                                // // console.log(data);
                                // // console.log(status);
                            });
                        }    
                    };
                $scope.activate = function(categoryid) 
                    {
                        if (categoryid) 
                        { 
                            $http({
                                url: "/categories/activate/deactivate",
                                method: "POST",
                                data: {"userid":$scope.userid, "token":$scope.token, "categoryid":categoryid , "action" : true}
                            }).success(function(data, status, headers, config) 
                            {
                                $scope.updatecategory = data['data'];
                                angular.forEach($scope.updatecategory, function(value, key) {
                                  angular.forEach($scope.categoriesArray, function(value2, key2) {
                                      if (value2.categoryid == value.categoryid)
                                      {
                                        $scope.categoriesArray[key2].active = value.active;
                                        return false;
                                      }
                                    });
                                });
                                if (status == 200)
                                {
                                    swal("Activated!", "Category successfully activated.", "success");
                                }
                                // $scope.languagesArray = $scope.languagesArray.concat(data['last_added_language']);
                                // $scope.languagesArray = $scope.languagesArray.splice(0, 0, data['last_added_skill']);

                            }).error(function(data, status, headers, config) {
                                $scope.status = status;
                                // // console.log(data);
                                // // console.log(status);
                            });
                        }    
                    };
                $scope.edit = function(categoryid, categoryname) 
                    {
                        if (categoryid) 
                        { 
                            $scope.categoryname = categoryname;
                            $scope.categoryid = categoryid;
                            $scope.count = 1;
                            $scope.flag = true;
                            $scope.setFocus();
                            // // console.log($scope.count);
                            $scope.isSaveDisabled = true;
                            $scope.isUpdateDisabled = false;
                        }    
                    };
                $scope.setFocus = function() {
						var element = $window.document.getElementById("categoryname");
						element.focus();
					};
				$scope.cancel = function() {
                        $scope.categoryname = "";
                        $scope.categoryid = "";
                        $scope.flag = false;
                        $scope.setFocus();
                    };
                $scope.upload = function (file,templateid) {
                    //console.log("-- ",file[0])
                    //console.log("-- ",file['$ngfDataUrl'])
                    for (var i=0; i<file.length ; i++){
                        var upload_data = {"myimage":file[i],"userid":$scope.userid, "token":$scope.token,"templateid":templateid};
                        console.log(upload_data);
                        Upload.upload({
                        url: '/categories/image/upload',
                        method: 'POST',
                        data: upload_data

                    }).then(function (resp) { //upload function returns a promise
                        console.log(resp);
                        $scope.updatetemplateArray = data['last_added_category'];
                            angular.forEach($scope.updatetemplateArray, function(value, key) {
                                angular.forEach($scope.templatesArray, function(value2, key2) {
                                    if (value2.templateid == value.templateid)
                                    {
                                        $scope.templatesArray[key2].templatename = value.templatename;
                                        return false;
                                    }
                                });
                            });                        
                        }) 
                    }
                };
                
            $scope.readURL = function (input) {
                var url_data = [] ;
                var images = [];
                var k = 0 ; 
                url_data = input.files;
                // console.log(input,type);
                if (input.files) {
                    for(i=0;i<input.files.length;i++)
                    {
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            url_data.$ngfDataUrl = e.target.result ;
                            var image = {};
                            var type_array = url_data[k].name.split(".");
                            image.name = type_array[type_array.length-1];
                            image.src = e.target.result;
                            images.push(image);
                            k++;
                        };
                        reader.readAsDataURL(input.files[i]);  
                    }
                }
                console.log("images");
                console.log(images);
                
                $scope.url = url_data;
                //console.log("image : "+$scope.url);
                };
            });
        </script>
    </body>
</html>



